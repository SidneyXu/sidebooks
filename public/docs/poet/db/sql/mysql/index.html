<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="MySQL #  1、基本使用 #  1.1、查看当前所有连接 #  show processlist; 客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。
 show variables like &#39;wait_timeout’; 上面返回的单位为秒。如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。这时候如果你要继续，就需要重连，然后再执行请求了。
2、高可用方案 #  2.1、MySQL Replication &#43; MHA #  美团MHA MHA只负责MySQL主库的高可用。主库发生故障时，MHA会选择一个数据最接近原主库的候选主节点（这里只有一个从节点，所以该从节点即为候选主节点）作为新的主节点，并补齐和之前Dead Master 差异的Binlog。数据补齐之后，即将写VIP漂移到新主库上。
MHA脑裂问题 DB服务器的上联交换机出现了抖动，导致主库无法访问，被管理节点判定为故障，触发MHA切换，VIP被漂到了新主库上。随后交换机恢复，主库可被访问，但由于VIP并没有从主库上摘除，因此2台机器同时拥有VIP，会产生脑裂。我们对MHA Manager加入了向同机架上其他物理机的探测，通过对比更多的信息来判断是网络故障还是单机故障。
2.2、MySQL Cluster #  2.3、基于Paxos的MGR版本的MySQL #  3、性能优化 #  3.1、索引设计 #  该在哪种字段上添加索引
show index from &lt;table_name&gt;；   Cardinality：基数，表示字段的区分度。基数为采样统计，当变更的行数超过阀值时会触发重新采样。区分度越高索引越可能被使用。  当MySQL误用索引时
 如果explain分析，如果扫描行数rows和实际行数区别大，就执行analyze table &lt;table_name&gt; 对基数重新采样。 考虑修改语句。 新建一个更合适的索引，让优化器做选择。或者在某种场景下删除误用的索引。 强制使用force_index。  列的区别度越高索引收益越大。查看区分度的方法为 SELECT COUNT(DISTINCT col_name)/COUNT(*) FROM table_name。">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="MySQL" />
<meta property="og:description" content="MySQL #  1、基本使用 #  1.1、查看当前所有连接 #  show processlist; 客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。
 show variables like &#39;wait_timeout’; 上面返回的单位为秒。如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。这时候如果你要继续，就需要重连，然后再执行请求了。
2、高可用方案 #  2.1、MySQL Replication &#43; MHA #  美团MHA MHA只负责MySQL主库的高可用。主库发生故障时，MHA会选择一个数据最接近原主库的候选主节点（这里只有一个从节点，所以该从节点即为候选主节点）作为新的主节点，并补齐和之前Dead Master 差异的Binlog。数据补齐之后，即将写VIP漂移到新主库上。
MHA脑裂问题 DB服务器的上联交换机出现了抖动，导致主库无法访问，被管理节点判定为故障，触发MHA切换，VIP被漂到了新主库上。随后交换机恢复，主库可被访问，但由于VIP并没有从主库上摘除，因此2台机器同时拥有VIP，会产生脑裂。我们对MHA Manager加入了向同机架上其他物理机的探测，通过对比更多的信息来判断是网络故障还是单机故障。
2.2、MySQL Cluster #  2.3、基于Paxos的MGR版本的MySQL #  3、性能优化 #  3.1、索引设计 #  该在哪种字段上添加索引
show index from &lt;table_name&gt;；   Cardinality：基数，表示字段的区分度。基数为采样统计，当变更的行数超过阀值时会触发重新采样。区分度越高索引越可能被使用。  当MySQL误用索引时
 如果explain分析，如果扫描行数rows和实际行数区别大，就执行analyze table &lt;table_name&gt; 对基数重新采样。 考虑修改语句。 新建一个更合适的索引，让优化器做选择。或者在某种场景下删除误用的索引。 强制使用force_index。  列的区别度越高索引收益越大。查看区分度的方法为 SELECT COUNT(DISTINCT col_name)/COUNT(*) FROM table_name。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/docs/poet/db/sql/mysql/" /><meta property="article:section" content="docs" />



<title>MySQL | 编程之诗</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.8a55d5d9141238c9e2edb39b1b570a9123c99ae6d8dea771e1b67e2a27c9c36a.js" integrity="sha256-ilXV2RQSOMni7bObG1cKkSPJmubY3qdx4bZ&#43;KifJw2o=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.jpeg" alt="Logo" /><span>编程之诗</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="/docs/poet/" class="">服务端技术</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3dc0bcdeacac2d09e305588c01af0eb9" class="toggle"  />
    <label for="section-3dc0bcdeacac2d09e305588c01af0eb9" class="flex justify-between">
      <a href="/docs/poet/loadbalance/" class="">负载均衡与反向代理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/loadbalance/nginx/" class="">Nginx</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a4c0e00f472ffb291f5ccb931cf17910" class="toggle"  />
    <label for="section-a4c0e00f472ffb291f5ccb931cf17910" class="flex justify-between">
      <a href="/docs/poet/server/" class="">Web服务器</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server/tomcat/" class="">Tomcat</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6a989a0f7154c0e30fc000173d18d159" class="toggle"  />
    <label for="section-6a989a0f7154c0e30fc000173d18d159" class="flex justify-between">
      <a href="/docs/poet/config/" class="">配置管理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/config/apollo/" class="">Apollo</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0d7503870886eef7e4a90589c51e6702" class="toggle"  />
    <label for="section-0d7503870886eef7e4a90589c51e6702" class="flex justify-between">
      <a href="/docs/poet/discovery/" class="">服务发现</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/discovery/eureka/" class="">Eureka</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ea19dd2dad634391640e3eabea4a79a7" class="toggle"  />
    <label for="section-ea19dd2dad634391640e3eabea4a79a7" class="flex justify-between">
      <a href="/docs/poet/gateway/" class="">网关</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/gateway/spring-cloud-gateway/" class="">Spring Cloud Gateway</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-267bf1dbb24070fe23f16066764ac3e6" class="toggle"  />
    <label for="section-267bf1dbb24070fe23f16066764ac3e6" class="flex justify-between">
      <a href="/docs/poet/tolerance/" class="">服务容错</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/tolerance/hystrix/" class="">Hystrix</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/tolerance/sentinel/" class="">Sentinel</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1566bed1759084fe25fbedde211ab5f4" class="toggle"  />
    <label for="section-1566bed1759084fe25fbedde211ab5f4" class="flex justify-between">
      <a href="/docs/poet/server_framework/" class="">服务框架</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server_framework/dubbo/" class="">Dubbo</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server_framework/springboot/" class="">SpringBoot</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server_framework/async/" class="">异步编程</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server_framework/async/vertx/" class="">Vert.x</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server_framework/async/future/" class="">CompletableFuture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/server_framework/async/rxjava/" class="">RxJava</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-10b9a0cd112515f14ad77b17e9cd35d6" class="toggle"  />
    <label for="section-10b9a0cd112515f14ad77b17e9cd35d6" class="flex justify-between">
      <a href="/docs/poet/job/" class="">任务调度</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/job/xxljob/" class="">XXL-Job</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c668b765ae16f6575e8402e851bad064" class="toggle" checked />
    <label for="section-c668b765ae16f6575e8402e851bad064" class="flex justify-between">
      <a role="button" class="">数据库</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/sql/" class="">关系型数据库</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/sql/mysql/" class="active">MySQL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/docsql/" class="">文档型数据库</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/docsql/mongodb/" class="">MongoDB</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/colsql/" class="">列式数据库</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/colsql/cassandra/" class="">Cassandra</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/fullsql/" class="">全文数据库</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/fullsql/es/" class="">ElastisSearch</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/cache/" class="">缓存</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/cache/redis/" class="">Redis</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/appcache/" class="">应用内缓存</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/db/dbproxy/" class="">数据库中间件</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-4194a62f2f6ac00c0aad913c39e3bd62" class="toggle"  />
    <label for="section-4194a62f2f6ac00c0aad913c39e3bd62" class="flex justify-between">
      <a href="/docs/poet/mq/" class="">消息中间件</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/mq/kafka/" class="">Kafka</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d6892adfc8e66be03d32b33aaec13217" class="toggle"  />
    <label for="section-d6892adfc8e66be03d32b33aaec13217" class="flex justify-between">
      <a href="/docs/poet/bigdata/" class="">大数据</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6603b0b9c0113595b4be27635898f9b2" class="toggle"  />
    <label for="section-6603b0b9c0113595b4be27635898f9b2" class="flex justify-between">
      <a href="/docs/poet/test/" class="">测试与性能分析</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/test/benchmark/" class="">压力测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/test/jmh/" class="">基准测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/test/cpu/" class="">CPU和线程的性能分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/test/memory/" class="">内存和硬盘的性能分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/test/jvm/" class="">JVM的性能分析</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f257b7f175f4a36b9a290ec1d949339d" class="toggle"  />
    <label for="section-f257b7f175f4a36b9a290ec1d949339d" class="flex justify-between">
      <a href="/docs/poet/devops/" class="">Devops</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/devops/linux/" class="">Linux</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/devops/code/" class="">代码管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/poet/devops/log/" class="">日志管理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>MySQL</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mysql">MySQL</a>
      <ul>
        <li><a href="#1基本使用">1、基本使用</a></li>
        <li><a href="#2高可用方案">2、高可用方案</a></li>
        <li><a href="#3性能优化">3、性能优化</a></li>
        <li><a href="#4集群优化">4、集群优化</a></li>
        <li><a href="#5使用方法">5、使用方法</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h2 id="mysql">
  MySQL
  <a class="anchor" href="#mysql">#</a>
</h2>
<h3 id="1基本使用">
  1、基本使用
  <a class="anchor" href="#1%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8">#</a>
</h3>
<h4 id="11查看当前所有连接">
  1.1、查看当前所有连接
  <a class="anchor" href="#11%e6%9f%a5%e7%9c%8b%e5%bd%93%e5%89%8d%e6%89%80%e6%9c%89%e8%bf%9e%e6%8e%a5">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">show</span> processlist;
</span></span></code></pre></div><p>客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;wait_timeout’;  
</span></span></span></code></pre></div><p>上面返回的单位为秒。如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。这时候如果你要继续，就需要重连，然后再执行请求了。</p>
<h3 id="2高可用方案">
  2、高可用方案
  <a class="anchor" href="#2%e9%ab%98%e5%8f%af%e7%94%a8%e6%96%b9%e6%a1%88">#</a>
</h3>
<h5 id="21mysql-replication--mha">
  2.1、MySQL Replication + MHA
  <a class="anchor" href="#21mysql-replication--mha">#</a>
</h5>
<p>美团MHA
MHA只负责MySQL主库的高可用。主库发生故障时，MHA会选择一个数据最接近原主库的候选主节点（这里只有一个从节点，所以该从节点即为候选主节点）作为新的主节点，并补齐和之前Dead Master 差异的Binlog。数据补齐之后，即将写VIP漂移到新主库上。</p>
<p>MHA脑裂问题
DB服务器的上联交换机出现了抖动，导致主库无法访问，被管理节点判定为故障，触发MHA切换，VIP被漂到了新主库上。随后交换机恢复，主库可被访问，但由于VIP并没有从主库上摘除，因此2台机器同时拥有VIP，会产生脑裂。我们对MHA Manager加入了向同机架上其他物理机的探测，通过对比更多的信息来判断是网络故障还是单机故障。</p>
<h5 id="22mysql-cluster">
  2.2、MySQL Cluster
  <a class="anchor" href="#22mysql-cluster">#</a>
</h5>
<h5 id="23基于paxos的mgr版本的mysql">
  2.3、基于Paxos的MGR版本的MySQL
  <a class="anchor" href="#23%e5%9f%ba%e4%ba%8epaxos%e7%9a%84mgr%e7%89%88%e6%9c%ac%e7%9a%84mysql">#</a>
</h5>
<h3 id="3性能优化">
  3、性能优化
  <a class="anchor" href="#3%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96">#</a>
</h3>
<h4 id="31索引设计">
  3.1、索引设计
  <a class="anchor" href="#31%e7%b4%a2%e5%bc%95%e8%ae%be%e8%ae%a1">#</a>
</h4>
<p>该在哪种字段上添加索引</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">show</span> <span style="color:#66d9ef">index</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">&lt;</span>table_name<span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">；</span>
</span></span></code></pre></div><p>
  <img src="/images/db/mysql1.png" alt="image" /></p>
<ul>
<li>Cardinality：基数，表示字段的区分度。基数为采样统计，当变更的行数超过阀值时会触发重新采样。区分度越高索引越可能被使用。</li>
</ul>
<p>当MySQL误用索引时</p>
<ul>
<li>如果explain分析，如果扫描行数rows和实际行数区别大，就执行<code>analyze table &lt;table_name&gt;</code> 对基数重新采样。</li>
<li>考虑修改语句。</li>
<li>新建一个更合适的索引，让优化器做选择。或者在某种场景下删除误用的索引。</li>
<li>强制使用force_index。</li>
</ul>
<p>列的区别度越高索引收益越大。查看区分度的方法为 <code>SELECT COUNT(DISTINCT col_name)/COUNT(*) FROM table_name</code>。</p>
<h4 id="32为大表添加索引或字段">
  3.2、为大表添加索引或字段
  <a class="anchor" href="#32%e4%b8%ba%e5%a4%a7%e8%a1%a8%e6%b7%bb%e5%8a%a0%e7%b4%a2%e5%bc%95%e6%88%96%e5%ad%97%e6%ae%b5">#</a>
</h4>
<p>1、优先考虑类似 gh-ost 或者pt-online-schema-change这样的第三方方案，更加稳妥。</p>
<p>原理：</p>
<p>Gh-ost创建与原始表相似的幽灵表“源表名_gho”，增量地将数据从原始表分批次插入复制到幽灵表中（默认1000条一次，&ndash;chunk-size=1000），同时另一个线程读取binlog将正在进行的更改传播到幽灵表中。最后锁定原表，待binlog完全追上，将原始表替换为ghost表。</p>
<p>2、MySQL 5.6 版本以后，创建索引都支持 Online DDL 了。可以用于小表加索引。</p>
<p>ALTER TABLE t1 ADD COLUMN x INT, ALGORITHM=INPLACE;</p>
<p>INPLACE 算法，从 MySQL 5.6 开始被引入并默认使用。</p>
<p>3、传统方案，在从库上执行操作，然后主从切换。</p>
<p>一主一备，主库 A、备库 B，步骤如下：</p>
<ol>
<li>在备库 B 上执行 set sql_log_bin=off，也就是不写 binlog，然后执行 alter table 语句加上索引；</li>
<li>执行主备切换；这时候主库是 B，备库是 A。</li>
<li>在 A 上执行 set sql_log_bin=off，然后执行 alter table 语句加上索引。</li>
</ol>
<p>在需要紧急处理时，这个方案的效率是最高的。</p>
<p>4、Alter 加时间，防止MDL影响线上数据读取。<code>alter table table_nam wait 10 add column</code>。</p>
<p>大表加字段：建新表转移数据后重命名表名；alter+时间；online ddl；</p>
<p>5、建空表通过触发器刷新数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> main_table_new <span style="color:#66d9ef">LIKE</span> main_table;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> main_table_new <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">COLUMN</span> location <span style="color:#66d9ef">VARCHAR</span>(<span style="color:#ae81ff">256</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> main_table_new <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">FROM</span> main_table;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RENAME</span> <span style="color:#66d9ef">TABLE</span> main_table <span style="color:#66d9ef">TO</span> main_table_old, main_table_new <span style="color:#66d9ef">TO</span> main_table;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> main_table_old;
</span></span></code></pre></div><h4 id="33sql优化">
  3.3、SQL优化
  <a class="anchor" href="#33sql%e4%bc%98%e5%8c%96">#</a>
</h4>
<p>优化 SQL 语句的步骤</p>
<ol>
<li>
<p>通过 EXPLAIN 分析 SQL 执行计划</p>
<ul>
<li>
<p>id：每个执行计划都有一个 id，如果是一个联合查询，这里还将有多个 id。</p>
</li>
<li>
<p>select_type：表示 SELECT 查询类型，常见的有 SIMPLE（普通查询，即没有联合查询、子查询）、PRIMARY（主查询）、UNION（UNION 中后面的查询）、SUBQUERY（子查询）等。</p>
</li>
<li>
<p>table：当前执行计划查询的表，如果给表起别名了，则显示别名信息。</p>
</li>
<li>
<p>partitions：访问的分区表信息。</p>
</li>
<li>
<p>type：表示从表中查询到行所执行的方式，查询方式是 SQL 优化中一个很重要的指标，结果值从好到差依次是：system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL。</p>
</li>
<li>
<p>system/const：表中只有一行数据匹配，此时根据索引查询一次就能找到对应的数据。</p>
</li>
<li>
<p>eq_ref：使用唯一索引扫描，常见于多表连接中使用主键和唯一索引作为关联条件。</p>
</li>
<li>
<p>ref：非唯一索引扫描，还可见于唯一索引最左原则匹配扫描。</p>
</li>
<li>
<p>range：索引范围扫描，比如，&lt;，&gt;，between 等操作。</p>
</li>
<li>
<p>index：索引全表扫描，此时遍历整个索引树。</p>
</li>
<li>
<p>ALL：表示全表扫描，需要遍历全表来找到对应的行。</p>
</li>
<li>
<p>possible_keys：可能使用到的索引。</p>
</li>
<li>
<p>key：实际使用到的索引。</p>
</li>
<li>
<p>key_len：当前使用的索引的长度。</p>
</li>
<li>
<p>ref：关联 id 等信息。</p>
</li>
<li>
<p>rows：查找到记录所扫描的行数。</p>
</li>
<li>
<p>filtered：查找到所需记录占总扫描记录数的比例。</p>
</li>
<li>
<p>Extra：额外的信息。</p>
</li>
</ul>
</li>
<li>
<p>通过 Show Profile 分析 SQL 执行性能。通过 EXPLAIN 分析执行计划，仅仅是停留在分析 SQL 的外部的执行情况，如果我们想要深入到 MySQL 内核中，从执行线程的状态和时间来分析的话，这个时候我们就可以选择 Profile。</p>
<pre tabindex="0"><code class="language-msql" data-lang="msql">set profiling=0;

show profiles；

# 查看具体的步骤时间
SHOW PROFILE [type [, type] ... ]
[FOR QUERY n]
[LIMIT row_count [OFFSET offset]]
</code></pre><p>type参数：</p>
<ul>
<li>
<p>| ALL：显示所有开销信息</p>
</li>
<li>
<p>| BLOCK IO：阻塞的输入输出次数</p>
</li>
<li>
<p>| CONTEXT SWITCHES：上下文切换相关开销信息</p>
</li>
<li>
<p>| CPU：显示CPU的相关开销信息</p>
</li>
<li>
<p>| IPC：接收和发送消息的相关开销信息</p>
</li>
<li>
<p>| MEMORY ：显示内存相关的开销，目前无用</p>
</li>
<li>
<p>| PAGE FAULTS ：显示页面错误相关开销信息</p>
</li>
<li>
<p>| SOURCE ：列出相应操作对应的函数名及其在源码中的调用位置(行数)</p>
</li>
<li>
<p>| SWAPS：显示swap交换次数的相关开销信息
show Profiles 只显示最近发给服务器的 SQL 语句，默认情况下是记录最近已执行的 15 条记录，我们可以重新设置 profiling_history_size 增大该存储记录，最大值为 100。另外该功能实际已被弃用，将来会被移除。官方推荐用performance_schema库的event_statment_**相关表替代，里面有87张表，部分功能默认开启。</p>
</li>
</ul>
</li>
</ol>
<h4 id="34慢查询分析">
  3.4、慢查询分析
  <a class="anchor" href="#34%e6%85%a2%e6%9f%a5%e8%af%a2%e5%88%86%e6%9e%90">#</a>
</h4>
<p>在开发阶段，衡量一个 SQL 查询语句查询性能的手段是，估计执行 SQL 时需要遍历的数据行数。遍历行数在百万以内，可以认为是安全的 SQL，百万到千万这个量级则需要仔细评估和优化，千万级别以上则是非常危险的。为了减少慢 SQL 的可能性，每个数据表的行数最好控制在千万以内。</p>
<p>1、慢查询日志</p>
<p>通过以下命令行查询是否开启了记录慢 SQL 的功能，以及最大的执行时间是多少：</p>
<pre tabindex="0"><code class="language-msql" data-lang="msql">Show variables like &#39;slow_query%&#39;;
Show variables like &#39;long_query_time&#39;;
</code></pre><p>开启慢查询日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">set</span> global slow_query_log<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ON&#39;</span>; <span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">开启慢</span>SQL日志
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> global slow_query_log_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/var/lib/mysql/test-slow.log&#39;</span>;<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">记录日志地址</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">set</span> global long_query_time<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">最大执行时间</span>
</span></span></code></pre></div><p>2.、information_schema</p>
<p>查询长事务</p>
<p>可以在 information_schema 库的 innodb_trx 这个表中查询长事务，比如下面这个语句，用于查找持续时间超过 60s 的事务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> information_schema.innodb_trx <span style="color:#66d9ef">where</span> <span style="color:#a6e22e">TIME_TO_SEC</span>(<span style="color:#a6e22e">timediff</span>(<span style="color:#a6e22e">now</span>(),trx_started))<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">60</span>
</span></span></code></pre></div><p>3、pt-query-digest</p>
<h4 id="35处理慢sql">
  3.5、处理慢SQL
  <a class="anchor" href="#35%e5%a4%84%e7%90%86%e6%85%a2sql">#</a>
</h4>
<p>定时检测</p>
<p>上线一个定时监控和杀掉慢 SQL 的脚本。这个脚本每分钟执行一次，检测有没有执行时间超过一分钟的慢 SQL，如果发现，直接杀掉这个会话。</p>
<p>降级</p>
<p>做一个简单的静态页面的首页作为降级方案，只要包含商品搜索栏、大的品类和其他顶级功能模块入口的链接就可以了。在 Nginx 上做一个策略，如果请求首页数据超时的时候，直接返回这个静态的首页作为替代。这样后续即使首页再出现任何的故障，也可以暂时降级，用静态首页替代。至少不会影响到用户使用其他功能。</p>
<h4 id="36历史数据清理">
  3.6、历史数据清理
  <a class="anchor" href="#36%e5%8e%86%e5%8f%b2%e6%95%b0%e6%8d%ae%e6%b8%85%e7%90%86">#</a>
</h4>
<p>1、表空间没有释放的原因</p>
<p>和 InnoDB 的物理存储结构有关系。虽然逻辑上每个表是一颗 B+ 树，但是物理上，每条记录都是存放在磁盘文件中的，这些记录通过一些位置指针来组织成一颗 B+ 树。当 MySQL 删除一条记录的时候，只是把文件的这块区域标记为空闲，然后再修改 B+ 树中相关的一些指针，完成删除。其实那条被删除的记录还是躺在那个文件的那个位置，所以并不会释放磁盘空间。</p>
<p>2、建立新表</p>
<p>建立新表是最快的方式，但是需要停服。具体来说就是将数据复制到新表，然后改名。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e">-- 新建一个临时订单表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> orders_temp <span style="color:#66d9ef">like</span> orders;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 把当前订单复制到临时订单表中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> orders_temp
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> <span style="color:#66d9ef">timestamp</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">SUBDATE</span>(<span style="color:#a6e22e">CURDATE</span>(),<span style="color:#66d9ef">INTERVAL</span> <span style="color:#ae81ff">3</span> month);
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 修改替换表名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">rename</span> <span style="color:#66d9ef">table</span> orders <span style="color:#66d9ef">to</span> orders_to_be_droppd, orders_temp <span style="color:#66d9ef">to</span> orders;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 删除旧表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> orders_to_be_dropp
</span></span></code></pre></div><p>3、在线迁移。</p>
<p>分批删除历史订单数据，避免给线上数据库造成太大压力，可以基于主键删除进一步提高删除效率。</p>
<p>4、释放表空间</p>
<p>如果磁盘空间很紧张，非要把这部分磁盘空间释放出来，可以执行一次 OPTIMIZE TABLE 释放存储空间。</p>
<p>对于 InnoDB 来说，执行 OPTIMIZE TABLE 实际上就是把这个表重建一遍，执行过程中会一直锁表。另外，这么优化有个前提条件，MySQL 的配置必须是每个表独立一个表空间（innodb_file_per_table = ON），如果所有表都是放在一起的，执行 OPTIMIZE TABLE 也不会释放磁盘空间。</p>
<p>重建表的过程中，索引也会重建，这样表数据和索引数据都会更紧凑，不仅占用磁盘空间更小，查询效率也会有提升。那对于频繁插入删除大量数据的这种表，如果能接受锁表，定期执行 OPTIMIZE TABLE 是非常有必要的。</p>
<h3 id="4集群优化">
  4、集群优化
  <a class="anchor" href="#4%e9%9b%86%e7%be%a4%e4%bc%98%e5%8c%96">#</a>
</h3>
<h4 id="41主备延迟">
  4.1、主备延迟
  <a class="anchor" href="#41%e4%b8%bb%e5%a4%87%e5%bb%b6%e8%bf%9f">#</a>
</h4>
<p>在备库上执行<code>show slave status</code>可以看到备库落后主库多少秒（seconds_behind_master）。主备延迟的最直接表现是备库消费relay log的速度远低于主库生产bin log日志的速度。</p>
<p>如果只是看一下，可以连接到主库上用 show slave status 命令查看
如果你需要实时监控主从延迟，可以用 pt-heartbeat 工具。</p>
<p>备库延迟的原因</p>
<ul>
<li>主备机器性能差异。</li>
<li>读写分离，没有关注读库的性能。可以多接几个读库或者让读库多接几个从库分摊压力。</li>
<li>大事务。主库执行10min事务写入binlog后，备库也要执行同样时间。所以不要一次性删除大量数据，特别是历史数据，要分多个事务分批批删。</li>
<li>大表DDL。应使用gh-ost方案。</li>
</ul>
<h4 id="42主备切换">
  4.2、主备切换
  <a class="anchor" href="#42%e4%b8%bb%e5%a4%87%e5%88%87%e6%8d%a2">#</a>
</h4>
<p>手动主备切换流程</p>
<ol>
<li>备库 readonly=true，只读。</li>
<li>在备库查看 seconds_behind_master，低于5秒则执行下一步，否则重试。</li>
<li>设置主库 readonly=true，只读。</li>
<li>在备库查看 seconds_behind_master，等于0则执行下一步，否则重试。</li>
<li>把备库 readonly=false。</li>
<li>把业务切换到备库。</li>
</ol>
<h4 id="43一主多从切换">
  4.3、一主多从切换
  <a class="anchor" href="#43%e4%b8%80%e4%b8%bb%e5%a4%9a%e4%bb%8e%e5%88%87%e6%8d%a2">#</a>
</h4>
<p>例如主机A和备机A`互备，从机B、C、D作为主机A的从机，提供只读功能。</p>
<p>使用GTID进行切换</p>
<p>GTID 的全称是 Global Transaction Identifier，也就是全局事务 ID，是一个事务在提交的时候生成的，是这个事务的唯一标识。</p>
<p>格式是：GTID=server_uuid:gno</p>
<p>server_uuid 是一个实例第一次启动时自动生成的，是一个全局唯一的值；gno 是一个整数，初始值是 1，每次提交事务的时候分配给这个事务，并加 1。</p>
<p>GTID 模式的启动也很简单，我们只需要在启动一个 MySQL 实例的时候，加上参数 gtid_mode=on 和 enforce_gtid_consistency=on 就可以了。</p>
<p>MySQL 5.6 版本引入的 GTID 模式。</p>
<h4 id="44主库的健康检查">
  4.4、主库的健康检查
  <a class="anchor" href="#44%e4%b8%bb%e5%ba%93%e7%9a%84%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5">#</a>
</h4>
<p><code>select 1</code> 语句返回成功只能说明这个库的进程还在，并不能说明主库没问题。另外，当服务器日志满了后，还是能提供查询功能。所以查询表语句也不行。</p>
<p>解决方法为自建系统表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">update</span> mysql.health_check <span style="color:#66d9ef">set</span> t_modified<span style="color:#f92672">=</span><span style="color:#a6e22e">now</span>();
</span></span></code></pre></div><p>如果是双主，由于双主会互相将数据同步给对方，所以以上语句可能会发生冲突。可以在表上再添加server_id字段作为标识。</p>
<h3 id="5使用方法">
  5、使用方法
  <a class="anchor" href="#5%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95">#</a>
</h3>
<h4 id="51java层读写分离">
  5.1、Java层读写分离
  <a class="anchor" href="#51java%e5%b1%82%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb">#</a>
</h4>
<ul>
<li>定义多个Datasource</li>
<li>save等操作时通过ThreadLocal注入枚举</li>
<li>实现AbstractRoutingDataSource接口，在方法determineCurrentLookupKey根据枚举返回对应的Datasource</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mysql">MySQL</a>
      <ul>
        <li><a href="#1基本使用">1、基本使用</a></li>
        <li><a href="#2高可用方案">2、高可用方案</a></li>
        <li><a href="#3性能优化">3、性能优化</a></li>
        <li><a href="#4集群优化">4、集群优化</a></li>
        <li><a href="#5使用方法">5、使用方法</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












