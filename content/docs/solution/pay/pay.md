---
weight: 1
title: 支付与清结算系统
---

# 支付与清结算系统

### 数据建模

- 扣款中日志表：用于进行补偿。为了保证查询效率，需要定期删除，控制表大小。
- 扣款执行日志表：只插入不更新，用于补偿的恢复，类似断点续传。

### 线上支付流程

1. 数据库设为自动提交，避免日志也被回滚。
2. 插入扣款中日志表，插入扣款执行日志表”扣款中“，更新支付单状态为“扣款中”。
3. 同步调用第三方渠道扣款，插入扣款执行日志表”渠道支付完成“。
   1. 返回扣款成功。
      1. 消息队列通知账务系统入账，插入扣款执行日志表”通知账务系统完成“。
      2. 更新支付单状态为“扣款完成”，插入扣款执行日志表”扣款成功“。
   2.  返回扣款失败。
      1. 更新支付单状态为“支付失败”，插入扣款执行日志表”扣款失败“。
   3. 返回扣款中。
      1. 定期反查支付结果，直到出现完成或失败。

有多个地方可能会对同一笔订单进行支付

- 正常执行扣款；
- 提交到后台线程池的重试 / 轮询；
- 定时任务补偿；
- 人工执行扣款

所以针对单笔记录可以用分布式锁进行限制，在数据库层面通过令牌或版本号进行兜底。最后通过日志记录来进行校正。

> 注意金额条件where amount=1000不能用于兜底，因为存在ABA问题。只能通过amount>判断超卖。

### 补偿流程

1. 每隔3分钟从扣款中日志表中找出3分钟前开始且状态为“扣款中”的记录。
2. 调用接口反查结果。
   1. 还在执行中，返回。
   2. 否。从扣款执行日志表中取出上次状态，继续执行。

### 二维码支付流程

和普通支付的区别：微信/支付宝其他支付接口在支付成功之后，渠道方会发送消息通知支付结果。但是付款码是不会有消息通知的。

业务流程

1. 商家通过扫码设备扫描用户支付宝付款码。
2. 扫码设备上传条码信息到收银台。
3. 收银台通过支付网关发起支付。
4. 支付网关调用支付宝支付后台。
   1. 当免密支付时，支付宝后台同步返回支付结果。
   2. 当支付宝风控要求用户输入密码时，支付宝后台返回“等待用户支付”状态。支付网关需要定时调用支付宝接口查询支付结果。如果在一段时间内（30s），轮询查询支付结果返回都是等待用户支付，或者失败和支付系统超时，这两种情况建议立刻调用撤销接口撤销交易。
5. 如果用户支付失败，撤销接口会订单关闭；如果用户支付成功，撤销接口会将订单资金退还给用户。也就是说撤销支付接口功能上等同与关闭订单加上退款。虽然撤销也具有退款功能，但是两者存在比较大的区别：
   1. 支付类型限制：撤销支付仅能撤销付款码类型的订单，而退款可以支持多种支付类型的订单。
   2. 退款金额：撤销接口只能是全额退款，而退款接口支持传入金额，可以全额退款，也可以部分退款。
   3. 时间限制：撤销接口时间限制短，微信支付撤销支持 7 天内的订单，而支付宝撤销接口仅支持当天的订单。退款接口可以支持较长时间订单退款，微信支付退款支持一年内的订单，而支付宝仅支持 3 个月内订单。

### 秒杀支付

业务需求

秒杀时，钱不是从买家账号直接打到卖家账号，而是先打到中间账号，也叫作担保账号。所以在处理秒杀的时候，只需要处理买家账号到中间账号的流量问题。从支付系统角度来看，只要买家账号能正确扣款就行，中间账号稍微延迟一点打款完全没问题。再进一步分析，中间账号的打款就算丢了也问题不大。支付系统在每天晚上日切的时候进行对账就能补齐金额。这就意味着中间账号可以异步处理。

实现方式

1. 支付系统只处理买家账号，记录扣款流水。
2. 通过异步方式处理中间账号，或者在秒杀结束后再处理中间账号。
3. 日切进行对账补齐差异。

### 支付网关系统

业务需求

支付网关需实现路由功能，能根据不同支付单信息分发给不同的资产处理组件。

- 内部资产处理组件：代金券系统、钱包系统。
- 外部资产处理组件：通过金融网关对接第三方支付系统和银行。

内部和外部资产处理组件都需要将信息同步到账务系统。核算系统根据业务系统的交易订单、账务系统的账务信息、第三方支付系统的对账单进行对账。

### 资金安全

- 实时对账。
- 出金须有结算周期，一般至少一周以上，方便核准金额。
- 防止资损。对退款，结算和出金做熔断控制，因为这些资金会流出平台。
- 熔断支持配置，按业务维度，指定单号和商户号。
- 当需要修复支付数据时，需要先进行熔断。

### 还款计划

业务需求

还款计划往往每月最后一天进行计算，所以存在数据量多，数据库压力大的问题。

还款开始-写入还款请求-mq-还款计算-发起支付流程

## 清算系统

一笔交易订单产生后，支付系统会把这笔订单的内容封装成各类交易，然后通过各种场景协议组成交易报文，生成支付指令，并同步到清算系统。清算系统根据支付系统的支付指令，通过渠道路由管理和任务调度，生成清算指令，然后向银行端报清算。银行处理后会通知清算系统，清算系统再将结果通知到支付系统。到此交易完成，进入账务处理。账务系统以账户的方式记录这笔交易的账务流水，更新分户账余额；会计系统以会计科目复式记账的方式登记分录流水。

在做结算的时候，京东遇到一个难题是，结算的牵扯的数量太大。如果每天按照500万订单来算，一年下来有多少数据?十年呢?

京东的结算支持全生命周期防重，保证只要用户提交过一次结算，绝不能提交第二次结算。

在数据体量小的时候很简单，创建一个数据防重表就可以解决。但是在数量巨大的时候，还要保证性能高效，还要考虑硬件成本和研发成本，怎么解决?我们的解决方案是补偿性防重。

补偿性防重?结算数据拆分为准生产数据数据和结算完毕历史数据。

第一阶段： 准生产数据数据实现防重

用关系型数据库即可实现，降低研发成本，并且能保证接口性能，且组成计算中心可以横向扩展调度。

第二阶段： 二阶段补偿防重

结算历史数据存储在大数据平台，降低存储成本，而且方便后续分析

如果第一关防重过了，这时后台启动，自动去校验历史数据。如果历史数据校验确实在历史当中存在，已经被结算了，那这个单子会被打回来。