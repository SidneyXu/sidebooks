---
weight: 4
title: 对账中心
---

# 对账中心

## 业务需求

- 双向对账。先以平台方数据为基准，再以渠道方数据为基准。
- 总账结合明细账。总账平不代表明细账平，业务系统刚上线时可以直接对明细账。进入平稳期后为提高对账效率，可以先对总账，不平后再对明细账。
- 对账依据：
   + 平台方信息流数据与资金流数据进行对账。
   + 平台方资金流数据与渠道方资金流数据进行对账。
- 对账方法
   + 只实时对账。对账成功的数据成为待清算数据。
   + 只批处理对账。对账成功的数据成为待清算数据。
   + 实时对账+批处理对账。实时对账防止出金资损，批处理对账做兜底保护。批处理对账成功的数据成为待清算数据。


## 实时对账

### 消息队列实时对账

1. 实时通过消息队列获取平台支付订单。
2. 调用渠道接口实时获取渠道交易结果。
3. 将支付订单信息和渠道交易结果进行对账，对账成功的数据作为待清算数据。
   - 渠道返回交易成功：
      + 金额不一致，对账失败，记为差错记录，等待人工处理。
      + 金额一致，
         * 支付系统返回成功，对账成功，支付数据可作为待清算数据。
         * 支付系统返回失败，对账商标，记为差错记录，等待人工处理。
         * 支付系统返回处理中，对账成功，自动纠错，更新支付数据为交易成功。
   - 渠道返回交易失败：
      + 支付系统返回成功，对账失败，记为差错记录，等待人工处理。
      + 支付系统返回失败，对账成功。
      + 支付系统返回处理中，对账成功，自动纠错，更新支付数据为交易失败。
   - 渠道返回交易不存在：
      + 对账失败，记为平台长款，等待人工处理。
4. 按清算周期生成商户对账文件，推送给商户。
5. 根据对账文件和商户进行结算。
6. 提供异常单查询功能供商户查看未及时进行结算的交易。

### Flink实时对账

同时读入两条流的数据来做合并处理。利用connect将两条流进行连接，然后用collect进行处理或者使用join。

### 唯品会分布式实时对账

1. 将各交易流水同步到到实时对账系统。
2. 根据交易流水号进行哈希计算，以此为依据进行分区对账。
3. 定时检测数据库的交易记录，为了防止主从延迟，接收到对账请求后延迟一段时间后再执行。
4. 对账任务扫描交易发起方和接收方的记录数据，生成对账结果。由于卖家是有结算周期的，所以可以在结算周期前做安全拦截。
5. 将对账结果同步到财务系统。


## 批处理对账

### 差集对账

1. 利用pipeline功能将平台方支付数据（流水号+交易金额）批量插入Redis的Set中。
2. 利用pipeline功能将渠道方支付数据（流水号+交易金额）批量插入Redis的Set中。
3. 以平台支付订单为基准，利用sdiff，找出平台方差集。
4. 以渠道方支付订单为基准对账，利用sdiff，找出渠道方差集。
5. 根据差集结果区分金额不一致、平台方长款和平台方短款。

### 滚动对账

1. 平台方数据和渠道方数据按流水号有序保存在数据库中。
2. 从平台方数据和渠道方数据中各取N条数据。
3. 从第1条开始对比，流水号和金额都一致则双方游标向后滑动一条记录。
4. 金额不一致则记为差错数据，转人工处理，双方游标向后滑动一条记录。
5. 流水号不一致，较小的一方记为差错数据，转人工处理。较小一方的游标向后滑动一条记录。
6. N条数据用完后，再取N条数据放入内存中，重复对账过程。

### 联通数据块对账

1. 确定基准时间(如10:00)，当前对账时间(如10:30)和待对账数据。
2. 获取在基准时间和当前对账时间之间写入的数据，通过md5生成校验码。
3. 判断对账双方生成的校验码是否一致。
4. 若一致，则将当前对账时间作为下一基准时间。
5. 若不一致，根据缺失数据向数据接收方重传数据，数据接收方将重传数据写入 目的数据库中，直至数据重传后获取的目的快照表和源快照表一致，将当前对账时间设置 作为下一基准时间。


