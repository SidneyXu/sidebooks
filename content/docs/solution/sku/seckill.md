---
weight: 10
title: 秒杀系统
bookHidden: true
---

# 秒杀系统

## 性能优化点

- 热门资源隔离：秒杀业务时间短，并发量大 ，针对热门商品进行独立部署以及资源分配。
- 商品页静态化。秒杀页面可以更简单化，因为用户在该场景下更关心尽早进入秒杀页面。
- 使用CDN。
- 临时增加带宽。
- 通过下发令牌等手段阻止用户在秒杀前拿到URL进行秒杀请求。
- 浏览器只有在秒杀开始后刷新请求才能获得具有秒杀能力的JS文件，之前的JS文件虽然同名但按钮为灰色，可以在JS文件后加上版本号避免被缓存。
- 部分功能可以降级。
  - 送货地址可降级为不可变更。
  - 用户注册功能可降级。
  - 历史订单查询可降级。
  - 退款功能可降级。
- 从上到下进行流量削峰：按正常用户/爬虫用户/VIP用户，非法路径/非法参数，IP+用户ID做频次限制
- 消息队列和缓存计数器限制并发进入数据库的数量。当一款商品库存只有 10 件却有 1 万名用户下单的时候，只有前 10 名客户可以下单成功，其他用户都浪费时间在队列等待以及无意义地查询库存，既牺牲了用户体验也增加了消息队列以及数据库的压力。
- 拒绝服务：当系统压力到达一个阈值的的时候，随机丢弃部分秒杀请求。
- 减少重试：将重试次数降低甚至设置为0，否则容易造成雪崩效应，系统陷入负反馈循环，无法正常恢复。

## 商品打标

通过在商品上打标可以让秒杀流量被正确地路由到隔离出来的专有秒杀环境。

设计思路

使用一个 long 型字段 skuTags 来保存各种标记，long 是 64 位，每一位代表一种类型的活动，0 代表否，1 代表是。假设skuTags 的第 11 位为秒杀标记，那么打标只要进行“或”操作：skuTags=skuTags|1024，这样 skuTags 字段的第 11 位就变成了 1。去标过程相反，同样进行位操作，skuTags=skuTags&~1024，把第 11 位置为 0。

1. 首先业务通过提报系统对秒杀 sku 进行提报，系统对秒杀 sku 进行打标。
2. 从独立的活动页、列表页或者搜索页点击商品的时候，系统就能识别出秒杀标，路由到秒杀的商品详情页域名，进而进入到专有 Nginx。
3. 在商品详情页进行限流。

## 预约秒杀

给预约过的用户发消息提醒，引导用户进行秒杀。一般的做法是根据 skuid 从 t_reserve_user 表取出预约过的用户，然后进行 push 推送。那么，当一个 sku 预约了几百万用户之后，这个查询会遇到深度分页的问题，越到后面查询越慢。

```mysql
select user_name from t_reserve_user where sku_id=#{skuId} limit #{page.beginIndex},#{page.step}
```

解决方法是不使用MySQL ，将数据放在redis或消息队列里，如果想更快的话可以拆分成多个redis key，多线程发送，规避了mysql的深度分页问题，可以很快速的把消息发出去。改造之后，几千万的消息发送，只要几分钟就完成了。


## 秒杀方案

1. 判断是否满足抢购条件，并针对IP限流
2. 进行权限验证
3. 请求队列，同一用户不能重复进队列，超过队列容量的有条件请求也被拒绝
4. 滚动扣除，根据队列长度扣减显示库存，返回给前端显示，显示库存小于0则返回0
5. 队列数据移到第二缓存队列，对于不超过真实库存数的数据采用排队加锁一个个请求扣除，update A = A-1 where A>0

内存数据

- 内存中：显示库存数、扣减库存数，数据库库存数
- 数据库库存数->扣减库存数->显示库存数
- 显示库存数>=0，扣减库存数可用小于0，用于限制请求数量