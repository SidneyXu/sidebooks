---
weight: 6
title: 促销系统
bookHidden: true
---

# 促销系统

## 促销系统

价格计算流程

1. 下单系统创建订单后，将商品信息和价格信息发送给促销系统。
2. 促销系统返回一个可以使用的促销列表。
3. 用户选择促销和优惠。下单系统把商品、价格、促销优惠这些信息，再次发送给促销模块。
4. 促销系统返回促销价格。
5. 订单系统记录使用的促销方式以及最终促销价。这样不管促销系统如何变化，其它业务模型也不需要改变。
6. 订单还要存储每个商品所均分的促销价。 比如A商品100元， B商品100元， 用户买了一件A+一件B ，激发了一个促销满200减10元，买个商品均摊5元。核心也是为了再做单件售后的时候，计算出首先对应的金额。

京东实时价格计算逻辑

- 写逻辑流程：
  1. 采销系统调整价格或建立促销时，将价格同步写入 MySQL 数据库
  2. 通过异步任务更新促销主 Redis 数据，并同时更新价格主 Redis 的过期时间戳
- 读逻辑流程：
  - 当用户在前端浏览商品列表、详情等页面时，异步访问价格实时服务，此时内嵌 Nginx 的 Lua 程序直接读取本地 Redis（从）中的价格数据，无过期则直接返回用户；
  - 若过期或不存在，则回源访问价格实时计算服务，即刻返回最新价格给用户。
- 回源写逻辑：价格实时计算服务读取促销主 Redis，在返回最新价格给用户的同时，异步写价格主 Redis 集群，价格主 Redis 同步数据至前置 Nginx 节点的从 Redis 节点。